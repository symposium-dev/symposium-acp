<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SACP Trace Viewer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #252526;
      padding: 12px 20px;
      border-bottom: 1px solid #3c3c3c;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    header h1 {
      font-size: 16px;
      font-weight: 500;
      color: #cccccc;
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .controls label {
      font-size: 13px;
      color: #9d9d9d;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .controls input[type="checkbox"] {
      accent-color: #0078d4;
    }

    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    #diagram-container {
      flex: 1;
      overflow: auto;
      padding: 20px;
    }

    #diagram {
      min-width: 100%;
    }

    #detail-panel {
      width: 400px;
      background: #252526;
      border-left: 1px solid #3c3c3c;
      display: flex;
      flex-direction: column;
      display: none;
    }

    #detail-panel.visible {
      display: flex;
    }

    #detail-panel header {
      padding: 10px 16px;
      border-bottom: 1px solid #3c3c3c;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #detail-panel header h2 {
      font-size: 14px;
      font-weight: 500;
    }

    #detail-panel .close-btn {
      background: none;
      border: none;
      color: #9d9d9d;
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
    }

    #detail-panel .close-btn:hover {
      color: #ffffff;
    }

    #detail-content {
      flex: 1;
      overflow: auto;
      padding: 16px;
    }

    #detail-content pre {
      font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, monospace;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* SVG styles */
    .swimlane-header {
      font-size: 12px;
      font-weight: 600;
      fill: #cccccc;
    }

    .swimlane-line {
      stroke: #3c3c3c;
      stroke-width: 1;
    }

    .message-arrow {
      stroke-width: 2;
      fill: none;
      cursor: pointer;
    }

    .message-arrow:hover {
      stroke-width: 3;
    }

    .message-arrow.acp {
      stroke: #4fc3f7;
    }

    .message-arrow.mcp {
      stroke: #81c784;
    }

    .message-arrow.response {
      stroke-dasharray: 6, 4;
      opacity: 0.7;
    }

    .message-arrow.error {
      stroke: #ef5350;
    }

    .arrow-head {
      fill: currentColor;
    }

    .message-label {
      font-size: 11px;
      fill: #d4d4d4;
      cursor: pointer;
    }

    .message-label:hover {
      fill: #ffffff;
    }

    .message-label.mcp {
      fill: #81c784;
    }

    .timestamp {
      font-size: 10px;
      fill: #6d6d6d;
    }

    .selected .message-arrow {
      stroke-width: 3;
    }

    .selected .message-label {
      fill: #ffffff;
      font-weight: 600;
    }

    /* Loading state */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #9d9d9d;
    }

    .error-message {
      color: #ef5350;
      padding: 20px;
    }
  </style>
</head>
<body>
  <header>
    <h1>SACP Trace Viewer</h1>
    <div class="controls">
      <label>
        <input type="checkbox" id="show-acp" checked>
        ACP
      </label>
      <label>
        <input type="checkbox" id="show-mcp" checked>
        MCP
      </label>
      <label>
        <input type="checkbox" id="show-responses" checked>
        Responses
      </label>
    </div>
  </header>

  <div class="main-container">
    <div id="diagram-container">
      <div class="loading">Loading trace...</div>
    </div>

    <div id="detail-panel">
      <header>
        <h2 id="detail-title">Message Details</h2>
        <button class="close-btn" onclick="closeDetailPanel()">&times;</button>
      </header>
      <div id="detail-content">
        <pre id="detail-json"></pre>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const SWIMLANE_WIDTH = 150;
    const ROW_HEIGHT = 40;
    const HEADER_HEIGHT = 40;
    const PADDING = 20;

    // State
    let events = [];
    let components = [];
    let selectedEvent = null;

    // Fetch and render events
    async function loadEvents() {
      try {
        const response = await fetch('/events');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }
        events = await response.json();

        // Extract unique components in order of appearance
        const componentSet = new Set();
        for (const event of events) {
          if (event.from) componentSet.add(event.from);
          if (event.to) componentSet.add(event.to);
        }
        components = Array.from(componentSet);

        // Sort to put client first, agent last
        components.sort((a, b) => {
          if (a === 'client') return -1;
          if (b === 'client') return 1;
          if (a === 'agent') return 1;
          if (b === 'agent') return -1;
          return a.localeCompare(b);
        });

        render();
      } catch (error) {
        document.getElementById('diagram-container').innerHTML =
          `<div class="error-message">Failed to load trace: ${error.message}</div>`;
      }
    }

    // Render the sequence diagram
    function render() {
      const container = document.getElementById('diagram-container');
      const showAcp = document.getElementById('show-acp').checked;
      const showMcp = document.getElementById('show-mcp').checked;
      const showResponses = document.getElementById('show-responses').checked;

      // Filter events based on checkboxes
      const filteredEvents = events.filter(event => {
        if (event.type === 'response' && !showResponses) return false;
        if (event.protocol === 'acp' && !showAcp) return false;
        if (event.protocol === 'mcp' && !showMcp) return false;
        // Responses inherit protocol from their request - for now show based on response checkbox
        if (event.type === 'response') return showResponses;
        return true;
      });

      const width = components.length * SWIMLANE_WIDTH + PADDING * 2;
      const height = HEADER_HEIGHT + filteredEvents.length * ROW_HEIGHT + PADDING * 2;

      let svg = `<svg id="diagram" width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">`;

      // Draw swimlane headers
      components.forEach((comp, i) => {
        const x = PADDING + i * SWIMLANE_WIDTH + SWIMLANE_WIDTH / 2;
        svg += `<text x="${x}" y="${PADDING + 15}" text-anchor="middle" class="swimlane-header">${comp}</text>`;
        // Draw vertical line
        svg += `<line x1="${x}" y1="${HEADER_HEIGHT}" x2="${x}" y2="${height}" class="swimlane-line"/>`;
      });

      // Draw messages
      filteredEvents.forEach((event, i) => {
        const y = HEADER_HEIGHT + i * ROW_HEIGHT + ROW_HEIGHT / 2;

        if (event.type === 'request' || event.type === 'notification') {
          const fromX = PADDING + components.indexOf(event.from) * SWIMLANE_WIDTH + SWIMLANE_WIDTH / 2;
          const toX = PADDING + components.indexOf(event.to) * SWIMLANE_WIDTH + SWIMLANE_WIDTH / 2;
          const direction = toX > fromX ? 1 : -1;
          const arrowX = toX - direction * 8;

          const protocolClass = event.protocol === 'mcp' ? 'mcp' : 'acp';

          svg += `<g class="message-group" data-index="${events.indexOf(event)}" onclick="selectEvent(${events.indexOf(event)})">`;

          // Arrow line
          svg += `<line x1="${fromX}" y1="${y}" x2="${arrowX}" y2="${y}" class="message-arrow ${protocolClass}"/>`;

          // Arrow head
          svg += `<polygon points="${toX},${y} ${arrowX},${y-5} ${arrowX},${y+5}" class="arrow-head" style="fill: ${event.protocol === 'mcp' ? '#81c784' : '#4fc3f7'}"/>`;

          // Label
          const labelX = (fromX + toX) / 2;
          const label = event.method || event.type;
          svg += `<text x="${labelX}" y="${y - 8}" text-anchor="middle" class="message-label ${protocolClass}">${truncate(label, 20)}</text>`;

          // Timestamp
          svg += `<text x="${PADDING - 5}" y="${y + 4}" text-anchor="end" class="timestamp">${event.ts?.toFixed(3) || ''}</text>`;

          svg += `</g>`;
        } else if (event.type === 'response') {
          const fromX = PADDING + components.indexOf(event.from) * SWIMLANE_WIDTH + SWIMLANE_WIDTH / 2;
          const toX = PADDING + components.indexOf(event.to) * SWIMLANE_WIDTH + SWIMLANE_WIDTH / 2;
          const direction = toX > fromX ? 1 : -1;
          const arrowX = toX - direction * 8;

          const errorClass = event.is_error ? 'error' : '';

          svg += `<g class="message-group" data-index="${events.indexOf(event)}" onclick="selectEvent(${events.indexOf(event)})">`;

          // Dashed arrow line
          svg += `<line x1="${fromX}" y1="${y}" x2="${arrowX}" y2="${y}" class="message-arrow response ${errorClass}"/>`;

          // Arrow head
          const color = event.is_error ? '#ef5350' : '#4fc3f7';
          svg += `<polygon points="${toX},${y} ${arrowX},${y-5} ${arrowX},${y+5}" class="arrow-head" style="fill: ${color}; opacity: 0.7"/>`;

          // Timestamp
          svg += `<text x="${PADDING - 5}" y="${y + 4}" text-anchor="end" class="timestamp">${event.ts?.toFixed(3) || ''}</text>`;

          svg += `</g>`;
        }
      });

      svg += `</svg>`;
      container.innerHTML = svg;
    }

    function truncate(str, maxLen) {
      if (str.length <= maxLen) return str;
      return str.substring(0, maxLen - 1) + '\u2026';
    }

    function selectEvent(index) {
      selectedEvent = events[index];

      // Update selection visual
      document.querySelectorAll('.message-group').forEach(g => g.classList.remove('selected'));
      const group = document.querySelector(`.message-group[data-index="${index}"]`);
      if (group) group.classList.add('selected');

      // Show detail panel
      const panel = document.getElementById('detail-panel');
      const title = document.getElementById('detail-title');
      const json = document.getElementById('detail-json');

      panel.classList.add('visible');

      if (selectedEvent.type === 'response') {
        title.textContent = selectedEvent.is_error ? 'Error Response' : 'Response';
      } else {
        title.textContent = selectedEvent.method || selectedEvent.type;
      }

      json.textContent = JSON.stringify(selectedEvent, null, 2);
    }

    function closeDetailPanel() {
      document.getElementById('detail-panel').classList.remove('visible');
      document.querySelectorAll('.message-group').forEach(g => g.classList.remove('selected'));
      selectedEvent = null;
    }

    // Event listeners
    document.getElementById('show-acp').addEventListener('change', render);
    document.getElementById('show-mcp').addEventListener('change', render);
    document.getElementById('show-responses').addEventListener('change', render);

    // Initial load
    loadEvents();
  </script>
</body>
</html>
